/**
 * @file cookieConsentBanner.js
 * @description A comprehensive GDPR-compliant cookie consent banner ES6 module
 * @version 1.0.0
 * @author Cyril Bosselut <contact@b1project.com>
 * @license MIT
 */
import MarkdownIt from"https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/+esm";window.cookieConsentBanner||(window.cookieConsentBanner=null);class CookieConsentBanner{constructor(e={}){this.config=this.mergeConfig(e),this.consentState=this.loadConsentState(),this.currentModal=null,this.markdownParser=new MarkdownIt({linkify:!0,breaks:!0}),this.init()}init(){this.consentState?this.applyConsentState():this.showConsentModal(),window.cookieConsentBanner=this,this.bindEvents()}mergeConfig(e){return{domain:e.domain||window.location.hostname,subdomains:e.subdomains||[],cookieExpiryDays:e.cookieExpiryDays||365,locale:e.locale||this.detectLocale(),localization:e.localization||{},privacyPolicyUrl:e.privacyPolicyUrl||"/locales/{locale}/privacy-policy.md",cookiePolicyUrl:e.cookiePolicyUrl||"/locales/{locale}/cookie-policy.md",termsUrl:e.termsUrl||"/locales/{locale}/terms.md",consentEndpoint:e.consentEndpoint,customData:e.customData||{},blockSiteOnFunctionalDeny:e.blockSiteOnFunctionalDeny||!1,theme:e.theme||{},thirdPartyHandlers:e.thirdPartyHandlers||{},...e}}detectLocale(){const e=navigator.language||navigator.languages?.[0];return e?.split("-")[0]||"en"}loadConsentState(){const e=this.getCookie("cookie_consent_state");if(!e)return null;try{return JSON.parse(decodeURIComponent(e))}catch(e){return console.warn("Failed to parse consent state cookie:",e),null}}saveConsentState(e){const t=encodeURIComponent(JSON.stringify(e));this.setCookie("cookie_consent_state",t,this.config.cookieExpiryDays,"fonctionnel"),e.analytical?this.generateAndSaveConsentToken(e):this.deleteCookie("cookie_consent_token")}generateAndSaveConsentToken(e){const t=this.generateUUID(),n={token:t,timestamp:e.timestamp,language:e.language,...this.config.customData};this.setCookie("cookie_consent_token",JSON.stringify(n),this.config.cookieExpiryDays,"analytique"),this.config.consentEndpoint&&this.sendConsentToEndpoint(t,this.config.customData)}async sendConsentToEndpoint(e,t){try{await fetch(this.config.consentEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,data:t,userAgent:navigator.userAgent,url:window.location.href})})}catch(e){console.warn("Failed to send consent to endpoint:",e)}}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null}setCookie(e,t,n,o="fonctionnel"){const c=new Date;c.setTime(c.getTime()+24*n*60*60*1e3);const i=[`expires=${c.toUTCString()}`,"path=/",`domain=${this.config.domain}`,"SameSite=Lax"];"https:"===location.protocol&&i.push("Secure"),document.cookie=`${e}=${t}; ${i.join("; ")}; type=${o}`}deleteCookie(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; domain=${this.config.domain}`}applyConsentState(){this.consentState&&(Object.entries(this.config.thirdPartyHandlers||{}).forEach(([e,t])=>{this.consentState[e]&&"function"==typeof t?t(!0):!1===this.consentState[e]&&"function"==typeof t&&t(!1)}),this.applyThirdPartyBlockers())}applyThirdPartyBlockers(){const{functional:e,analytical:t,performance:n,advertising:o,social:c}=this.consentState;t||this.blockGoogleAnalytics(),o||this.blockGoogleAdSense(),c||this.blockFacebook(),c||this.blockTwitter(),n||this.blockFirebase()}blockGoogleAnalytics(){["_ga","_ga_*","_gid","_gat"].forEach(e=>{const t=new RegExp(e.replace("*",".*"));document.cookie.split(";").forEach(e=>{t.test(e.trim().split("=")[0])&&this.deleteCookie(e.trim().split("=")[0])})});document.querySelectorAll('script[src*="google-analytics.com"], script[src*="googletagmanager.com"]').forEach(e=>e.remove())}blockGoogleAdSense(){["_gcl_au","__gads","__gpi"].forEach(e=>this.deleteCookie(e));document.querySelectorAll('script[src*="googlesyndication.com"], script[src*="doubleclick.net"]').forEach(e=>e.remove());document.querySelectorAll('.adsbygoogle, [id*="google_ads"]').forEach(e=>e.remove())}blockFacebook(){["_fbp","fr"].forEach(e=>this.deleteCookie(e));document.querySelectorAll('script[src*="connect.facebook.net"]').forEach(e=>e.remove()),window.FB=void 0}blockTwitter(){["personalization_id","guest_id"].forEach(e=>this.deleteCookie(e));document.querySelectorAll('script[src*="platform.twitter.com"]').forEach(e=>e.remove()),window.twttr=void 0}blockFirebase(){["_fbp"].forEach(e=>this.deleteCookie(e));document.querySelectorAll('script[src*="firebaseio.com"], script[src*="firebase.com"]').forEach(e=>e.remove())}showConsentModal(e="banner"){switch(this.currentModal=e,e){case"banner":this.showBannerModal();break;case"fullscreen":this.showFullscreenModal();break;case"management":this.showManagementModal()}}showBannerModal(){const e=this.createModal("banner");e.innerHTML=this.getBannerContent(),this.attachBannerEvents(e),document.body.appendChild(e)}showFullscreenModal(){const e=this.createModal("fullscreen");e.innerHTML=this.getFullscreenContent(),this.attachFullscreenEvents(e),document.body.appendChild(e)}showManagementModal(){const e=this.createModal("management");e.innerHTML=this.getManagementContent(),this.attachManagementEvents(e),document.body.appendChild(e)}createModal(e){const t=document.createElement("div");return t.className=`ccb-modal ccb-modal--${e}`,t.setAttribute("data-modal-type",e),t}getBannerContent(){const e=this.getLocalizedText;return`\n      <div class="ccb-banner">\n        <div class="ccb-banner__content">\n          <h3 class="ccb-banner__title">${e("cookieConsent.title")}</h3>\n          <p class="ccb-banner__description">${e("cookieConsent.description")}</p>\n          <div class="ccb-banner__actions">\n            <button class="ccb-btn ccb-btn--secondary ccb-btn--manage" data-action="manage">\n              ${e("cookieConsent.manageSettings")}\n            </button>\n            <button class="ccb-btn ccb-btn--secondary ccb-btn--reject" data-action="reject">\n              ${e("cookieConsent.rejectAll")}\n            </button>\n            <button class="ccb-btn ccb-btn--primary ccb-btn--accept" data-action="accept">\n              ${e("cookieConsent.acceptAll")}\n            </button>\n          </div>\n          <div class="ccb-banner__links">\n            <button class="ccb-link" data-action="policy" data-policy="privacy">\n              ${e("cookieConsent.privacyPolicy")}\n            </button>\n            <button class="ccb-link" data-action="policy" data-policy="cookie">\n              ${e("cookieConsent.cookiePolicy")}\n            </button>\n          </div>\n        </div>\n      </div>\n    `}getFullscreenContent(){const e=this.getLocalizedText,t=this.consentState||{};return`\n      <div class="ccb-fullscreen__content">\n        <div class="ccb-fullscreen__header">\n          <h2 class="ccb-fullscreen__title">${e("cookieConsent.title")}</h2>\n          <p class="ccb-fullscreen__description">${e("cookieConsent.fullscreenDescription")}</p>\n        </div>\n        \n        <div class="ccb-fullscreen__body">\n          <div class="ccb-consent-categories">\n            ${this.getConsentCategoriesHTML(t)}\n          </div>\n        </div>\n        \n        <div class="ccb-fullscreen__footer">\n          <div class="ccb-fullscreen__actions">\n            <button class="ccb-btn ccb-btn--secondary ccb-btn--reject" data-action="reject">\n              ${e("cookieConsent.rejectAll")}\n            </button>\n            <button class="ccb-btn ccb-btn--secondary ccb-btn--partial" data-action="partial">\n              ${e("cookieConsent.customChoice")}\n            </button>\n            <button class="ccb-btn ccb-btn--primary ccb-btn--accept" data-action="accept">\n              ${e("cookieConsent.acceptAll")}\n            </button>\n          </div>\n          \n          <div class="ccb-fullscreen__links">\n            <button class="ccb-link" data-action="policy" data-policy="privacy">\n              ${e("cookieConsent.privacyPolicy")}\n            </button>\n            <button class="ccb-link" data-action="policy" data-policy="cookie">\n              ${e("cookieConsent.cookiePolicy")}\n            </button>\n            <button class="ccb-link" data-action="policy" data-policy="terms">\n              ${e("cookieConsent.terms")}\n            </button>\n          </div>\n        </div>\n      </div>\n    `}getManagementContent(){const e=this.getLocalizedText,t=this.consentState||{};return`\n      <div class="ccb-management__content">\n        <div class="ccb-management__header">\n          <h2 class="ccb-management__title">${e("cookieConsent.manageSettings")}</h2>\n          <p class="ccb-management__description">${e("cookieConsent.manageDescription")}</p>\n        </div>\n        \n        <div class="ccb-management__body">\n          <div class="ccb-consent-categories">\n            ${this.getConsentCategoriesHTML(t)}\n          </div>\n        </div>\n        \n        <div class="ccb-management__footer">\n          <div class="ccb-management__actions">\n            <button class="ccb-btn ccb-btn--secondary ccb-btn--cancel" data-action="cancel">\n              ${e("cookieConsent.cancel")}\n            </button>\n            <button class="ccb-btn ccb-btn--primary ccb-btn--save" data-action="save">\n              ${e("cookieConsent.saveSettings")}\n            </button>\n          </div>\n          \n          <div class="ccb-management__links">\n            <button class="ccb-link" data-action="policy" data-policy="privacy">\n              ${e("cookieConsent.privacyPolicy")}\n            </button>\n            <button class="ccb-link" data-action="policy" data-policy="cookie">\n              ${e("cookieConsent.cookiePolicy")}\n            </button>\n          </div>\n        </div>\n      </div>\n    `}getConsentCategoriesHTML(e={}){return[{key:"functional",title:"cookieConsent.categories.functional.title",description:"cookieConsent.categories.functional.description",required:!0,default:!0},{key:"analytical",title:"cookieConsent.categories.analytical.title",description:"cookieConsent.categories.analytical.description",required:!1,default:!1},{key:"performance",title:"cookieConsent.categories.performance.title",description:"cookieConsent.categories.performance.description",required:!1,default:!1},{key:"advertising",title:"cookieConsent.categories.advertising.title",description:"cookieConsent.categories.advertising.description",required:!1,default:!1},{key:"social",title:"cookieConsent.categories.social.title",description:"cookieConsent.categories.social.description",required:!1,default:!1},{key:"other",title:"cookieConsent.categories.other.title",description:"cookieConsent.categories.other.description",required:!1,default:!1}].map(t=>{const n=void 0!==e[t.key]?e[t.key]:t.default,o=t.required?"disabled checked":"";return`\n        <div class="ccb-consent-category" data-category="${t.key}">\n          <div class="ccb-consent-category__header">\n            <div class="ccb-consent-category__info">\n              <h4 class="ccb-consent-category__title">${this.getLocalizedText(t.title)}</h4>\n              <p class="ccb-consent-category__description">${this.getLocalizedText(t.description)}</p>\n            </div>\n            <div class="ccb-consent-category__toggle">\n              <input \n                type="checkbox" \n                id="category-${t.key}" \n                name="${t.key}" \n                ${n?"checked":""} \n                ${o}\n                class="ccb-toggle"\n              />\n              <label for="category-${t.key}" class="ccb-toggle-label">\n                <span class="ccb-toggle-slider"></span>\n              </label>\n            </div>\n          </div>\n        </div>\n      `}).join("")}get getLocalizedText(){return e=>({"cookieConsent.title":"Cookie Consent","cookieConsent.description":"We use cookies to enhance your experience and analyze our traffic.","cookieConsent.fullscreenDescription":"Choose which cookies you want to allow. You can change these settings at any time.","cookieConsent.manageDescription":"Adjust your cookie preferences below.","cookieConsent.acceptAll":"Accept All","cookieConsent.rejectAll":"Reject All","cookieConsent.customChoice":"Custom Choice","cookieConsent.manageSettings":"Manage Settings","cookieConsent.saveSettings":"Save Settings","cookieConsent.cancel":"Cancel","cookieConsent.privacyPolicy":"Privacy Policy","cookieConsent.cookiePolicy":"Cookie Policy","cookieConsent.terms":"Terms of Use","cookieConsent.categories.functional.title":"Functional Cookies","cookieConsent.categories.functional.description":"These cookies are necessary for the website to function properly.","cookieConsent.categories.analytical.title":"Analytical Cookies","cookieConsent.categories.analytical.description":"These cookies help us understand how visitors interact with our website.","cookieConsent.categories.performance.title":"Performance Cookies","cookieConsent.categories.performance.description":"These cookies help us improve the performance of our website.","cookieConsent.categories.advertising.title":"Advertising Cookies","cookieConsent.categories.advertising.description":"These cookies are used to deliver relevant advertisements.","cookieConsent.categories.social.title":"Social Media Cookies","cookieConsent.categories.social.description":"These cookies enable social media features.","cookieConsent.categories.other.title":"Other Cookies","cookieConsent.categories.other.description":"Other uncategorized cookies.",...this.config.localization[this.config.locale]||{}}[e]||e)}attachBannerEvents(e){e.addEventListener("click",e=>{e.preventDefault();const t=e.target.getAttribute("data-action");"accept"===t?this.acceptAllConsent():"reject"===t?this.rejectAllConsent():"manage"===t?(this.closeModal(),this.showFullscreenModal()):"policy"===t&&(this.closeModal(),this.showPolicyModal(e.target.getAttribute("data-policy")))})}attachFullscreenEvents(e){e.addEventListener("click",e=>{const t=e.target.getAttribute("data-action");"accept"===t?this.acceptAllConsent():"reject"===t?this.rejectAllConsent():"partial"===t?this.saveCustomConsent():"policy"===t&&(this.closeModal(),this.showPolicyModal(e.target.getAttribute("data-policy")))})}attachManagementEvents(e){e.addEventListener("click",e=>{e.preventDefault();const t=e.target.getAttribute("data-action");"save"===t?this.saveCustomConsent():"cancel"===t?this.closeModal():"policy"===t&&(this.closeModal(),this.showPolicyModal(e.target.getAttribute("data-policy")))})}acceptAllConsent(){const e=this.createConsentState({functional:!0,analytical:!0,performance:!0,advertising:!0,social:!0,other:!0});this.saveAndApplyConsent(e)}rejectAllConsent(){const e=this.createConsentState({functional:!0,analytical:!1,performance:!1,advertising:!1,social:!1,other:!1});this.saveAndApplyConsent(e)}saveCustomConsent(){const e={functional:!0,analytical:document.querySelector('[name="analytical"]')?.checked||!1,performance:document.querySelector('[name="performance"]')?.checked||!1,advertising:document.querySelector('[name="advertising"]')?.checked||!1,social:document.querySelector('[name="social"]')?.checked||!1,other:document.querySelector('[name="other"]')?.checked||!1},t=this.createConsentState(e);this.saveAndApplyConsent(t)}createConsentState(e){return{...e,timestamp:(new Date).toISOString(),language:this.config.locale}}saveAndApplyConsent(e){this.consentState=e,this.saveConsentState(e),this.applyConsentState(),this.closeModal(),!e.functional&&this.config.blockSiteOnFunctionalDeny&&this.showFunctionalBlockedMessage(),window.dispatchEvent(new CustomEvent("cookieConsentSaved",{detail:{consentState:e,timestamp:(new Date).toISOString(),language:e.language}}))}showFunctionalBlockedMessage(){const e=this.createModal("blocked");e.innerHTML='\n      <div class="ccb-blocked__content">\n        <h2>Functionality Limited</h2>\n        <p>This website requires functional cookies to work properly. Please enable them to continue using our services.</p>\n        <button class="ccb-btn ccb-btn--primary" onclick="CookieConsentBanner.showConsentModal(\'banner\')">\n          Enable Cookies\n        </button>\n      </div>\n    ',document.body.appendChild(e)}async showPolicyModal(e){try{const t=this.getPolicyUrl(e),n=await this.loadMarkdownFile(t),o=this.createModal("policy");o.innerHTML=`\n        <div class="ccb-policy__content">\n          <div class="ccb-policy__header">\n            <h2 class="ccb-policy__title">${this.getPolicyTitle(e)}</h2>\n            <button class="ccb-policy__close" data-action="close">Ã—</button>\n          </div>\n          <div class="ccb-policy__body">\n            ${n}\n          </div>\n        </div>\n      `,o.addEventListener("click",e=>{"close"===e.target.getAttribute("data-action")&&(this.closeModal(),this.consentState||this.showConsentModal())}),document.body.appendChild(o)}catch(t){console.warn("Failed to load policy file:",t),window.open(this.getPolicyUrl(e),"_blank")}}getPolicyUrl(e){const t={privacy:this.config.privacyPolicyUrl,cookie:this.config.cookiePolicyUrl,terms:this.config.termsUrl};return t[e]?.replace("{locale}",this.config.locale)||"#"}getPolicyTitle(e){return{privacy:"Privacy Policy",cookie:"Cookie Policy",terms:"Terms of Use"}[e]||"Policy"}async loadMarkdownFile(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.text();return this.markdownParser.render(n)}catch(t){return console.warn("Failed to load markdown file:",e,t),"<p>Policy content could not be loaded.</p>"}}closeModal(){const e=document.querySelector(".ccb-modal");e&&(e.remove(),this.currentModal=null)}bindEvents(){document.addEventListener("keydown",e=>{"Escape"===e.key&&this.currentModal&&this.closeModal()}),document.addEventListener("click",e=>{const t=e.target.classList;t.contains("ccb-modal")&&("banner"!==this.currentModal?(this.closeModal(),t.contains("ccb-modal--policy")&&!this.consentState&&this.showConsentModal()):e.stopPropagation())})}showModal(e="banner"){this.closeModal(),this.showConsentModal(e)}getConsentState(){return this.consentState}hasConsent(e){return!0===this.consentState?.[e]}clearConsent(){this.deleteCookie("cookie_consent_state"),this.deleteCookie("cookie_consent_token"),this.consentState=null}registerThirdPartyHandler(e,t){this.config.thirdPartyHandlers=this.config.thirdPartyHandlers||{},this.config.thirdPartyHandlers[e]=t,this.consentState&&"function"==typeof t&&t(this.consentState[e])}}export default CookieConsentBanner;